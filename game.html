<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UvoWorld - Game</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            height: 100vh;
            overflow: hidden;
            color: white;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 2px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }
        
        .user-info {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .user-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .user-email {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .world-list {
            list-style: none;
        }
        
        .world-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .world-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .world-item.active {
            background: rgba(255, 255, 255, 0.3);
            border-left: 4px solid #ffcc00;
        }
        
        .btn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            margin-top: auto;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .current-world {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .resources {
            display: flex;
            gap: 15px;
        }
        
        .resource {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .resource-icon {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        /* Game World */
        .game-world {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        #game-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Controls */
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* Inventory */
        .inventory {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        
        .inventory-item {
            min-width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
            position: relative;
        }
        
        .inventory-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }
        
        .inventory-item.active {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid #ffcc00;
        }
        
        .item-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .item-name {
            font-size: 0.7rem;
            text-align: center;
        }
        
        .item-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
        }
        
        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* Animasi */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        /* Online Players */
        .online-players {
            margin-top: 10px;
        }
        
        .player {
            display: flex;
            align-items: center;
            padding: 5px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        .player-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-name" id="user-name">Username</div>
                <div class="user-email" id="user-email">user@example.com</div>
            </div>
            
            <div class="section">
                <div class="section-title">Dunia Saya</div>
                <ul class="world-list" id="world-list">
                    <!-- Daftar dunia akan diisi oleh JavaScript -->
                </ul>
                <button class="btn" id="create-world-btn">Buat Dunia Baru</button>
                <button class="btn" id="join-world-btn">Kunjungi Dunia</button>
            </div>
            
            <div class="section">
                <div class="section-title">Pemain Online</div>
                <div class="online-players" id="online-players">
                    <!-- Daftar pemain online akan diisi oleh JavaScript -->
                </div>
            </div>
            
            <button class="btn btn-logout" id="logout-btn">Keluar</button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="game-header">
                <div class="current-world" id="current-world">Memuat dunia...</div>
                <div class="resources">
                    <div class="resource">
                        <span class="resource-icon">💎</span>
                        <span id="gem-count">0</span>
                    </div>
                    <div class="resource">
                        <span class="resource-icon">🪙</span>
                        <span id="coin-count">0</span>
                    </div>
                </div>
            </div>
            
            <div class="game-world">
                <canvas id="game-canvas"></canvas>
                <div class="controls">
                    <button class="control-btn" id="jump-btn">↑</button>
                    <button class="control-btn" id="left-btn">←</button>
                    <button class="control-btn" id="right-btn">→</button>
                </div>
            </div>
            
            <div class="inventory" id="inventory">
                <!-- Inventory akan diisi oleh JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Modal Buat Dunia Baru -->
    <div class="modal" id="create-world-modal">
        <div class="modal-content fade-in">
            <div class="modal-title">Buat Dunia Baru</div>
            <input type="text" class="modal-input" id="world-domain" placeholder="Domain dunia (contoh: petualanganku)">
            <input type="text" class="modal-input" id="world-name" placeholder="Nama dunia (contoh: Petualanganku)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-create">Batal</button>
                <button class="modal-btn modal-btn-primary" id="confirm-create">Buat</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Masuk ke Dunia -->
    <div class="modal" id="join-world-modal">
        <div class="modal-content fade-in">
            <div class="modal-title">Masuk ke Dunia</div>
            <input type="text" class="modal-input" id="join-world-domain" placeholder="Domain dunia (contoh: petualanganku)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-join">Batal</button>
                <button class="modal-btn modal-btn-primary" id="confirm-join">Masuk</button>
            </div>
        </div>
    </div>

    <script>
        // Inisialisasi Firebase
        const firebaseConfig = {
            databaseURL: "https://duniauvo-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Data blok
        const blocks = [
            { id: 1, name: "Dirt Block", nameId: "Blok tanah", emoji: "🟫", color: "#8B4513" },
            { id: 2, name: "Grass Block", nameId: "Tanah berumput", emoji: "🟩", color: "#228B22" },
            { id: 3, name: "Stone Block", nameId: "Batu keras", emoji: "⬜", color: "#A9A9A9" },
            { id: 4, name: "Sand Block", nameId: "Pasir", emoji: "🟨", color: "#F4A460" },
            { id: 5, name: "Water Block", nameId: "Air", emoji: "🟦", color: "#1E90FF" },
            { id: 6, name: "Lava Block", nameId: "Lava panas", emoji: "🟥", color: "#FF4500" },
            { id: 7, name: "Ice Block", nameId: "Es", emoji: "🧊", color: "#87CEEB" },
            { id: 8, name: "Snow Block", nameId: "Salju", emoji: "⬜", color: "#F0F8FF" },
            { id: 9, name: "Cloud Block", nameId: "Awan", emoji: "☁️", color: "#F5F5F5" },
            { id: 10, name: "Brick Block", nameId: "Bata", emoji: "🧱", color: "#B22222" },
            { id: 11, name: "Coal Block", nameId: "Batu bara", emoji: "⬛", color: "#2F4F4F" },
            { id: 12, name: "Iron Block", nameId: "Besi", emoji: "⚪", color: "#C0C0C0" },
            { id: 13, name: "Gold Block", nameId: "Emas", emoji: "🟨", color: "#FFD700" },
            { id: 14, name: "Diamond Block", nameId: "Berlian", emoji: "💎", color: "#00FFFF" },
            { id: 15, name: "Emerald Block", nameId: "Zamrud", emoji: "🟢", color: "#00FF00" },
            { id: 16, name: "Ruby Block", nameId: "Ruby merah", emoji: "🔴", color: "#FF0000" },
            { id: 17, name: "Amethyst Block", nameId: "Batu ungu", emoji: "🟪", color: "#8A2BE2" },
            { id: 18, name: "Obsidian Block", nameId: "Obsidian", emoji: "⬛", color: "#191970" },
            { id: 19, name: "Crystal Block", nameId: "Kristal", emoji: "✨", color: "#E6E6FA" },
            { id: 20, name: "Light Block", nameId: "Blok bercahaya", emoji: "🌟", color: "#FFFF00" },
            { id: 21, name: "Wood Block", nameId: "Kayu dasar", emoji: "🟤", color: "#8B4513" },
            { id: 22, name: "Oak Plank Block", nameId: "Papan ek", emoji: "🟫", color: "#A0522D" },
            { id: 23, name: "Pine Plank Block", nameId: "Papan pinus", emoji: "🟤", color: "#8B4513" },
            { id: 24, name: "Bamboo Block", nameId: "Bambu", emoji: "🟩", color: "#006400" },
            { id: 25, name: "Leaf Block", nameId: "Daun", emoji: "🟢", color: "#32CD32" },
            { id: 26, name: "Mushroom Block", nameId: "Jamur", emoji: "🍄", color: "#FF69B4" },
            { id: 27, name: "Pumpkin Block", nameId: "Labu", emoji: "🎃", color: "#FF8C00" },
            { id: 28, name: "Melon Block", nameId: "Semangka", emoji: "🍉", color: "#90EE90" },
            { id: 29, name: "Wheat Block", nameId: "Gandum", emoji: "🌾", color: "#F0E68C" },
            { id: 30, name: "Cactus Block", nameId: "Kaktus", emoji: "🌵", color: "#9ACD32" }
        ];
        
        // Variabel global
        let currentUser = null;
        let currentWorld = null;
        let selectedBlock = blocks[0];
        let userWorlds = [];
        let userInventory = {};
        let onlinePlayers = {};
        
        // Konstanta game
        const BLOCK_SIZE = 40;
        const PLAYER_SIZE = 30;
        const GRAVITY = 0.5;
        const JUMP_FORCE = -10;
        
        // Variabel game
        let canvas, ctx;
        let camera = { x: 0, y: 0 };
        let keys = {};
        let player = {
            x: 100,
            y: 100,
            width: PLAYER_SIZE,
            height: PLAYER_SIZE,
            velocityX: 0,
            velocityY: 0,
            speed: 5,
            isJumping: false,
            color: '#FF0000',
            facing: 'right'
        };
        
        // Fungsi untuk memuat data user
        function loadUserData() {
            const userData = localStorage.getItem('uvoworld_user');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-email').textContent = currentUser.email || 'Tidak ada email';
            document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
            
            // Inisialisasi game
            initGame();
            
            // Memuat data user dari Firebase
            loadUserFromFirebase();
        }
        
        // Memuat data user dari Firebase
        function loadUserFromFirebase() {
            database.ref('users/' + currentUser.username).on('value', snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    document.getElementById('gem-count').textContent = userData.gems || 0;
                    document.getElementById('coin-count').textContent = userData.coins || 0;
                    userInventory = userData.inventory || {};
                    
                    // Update inventory display
                    updateInventoryDisplay();
                    
                    // Memuat dunia user
                    loadUserWorlds();
                }
            });
        }
        
        // Inisialisasi game
        function initGame() {
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            
            // Set ukuran canvas
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Event listener untuk keyboard
            window.addEventListener('keydown', function(e) {
                keys[e.key] = true;
                
                // Space untuk melompat
                if (e.key === ' ' || e.key === 'Spacebar') {
                    e.preventDefault();
                    jump();
                }
            });
            
            window.addEventListener('keyup', function(e) {
                keys[e.key] = false;
            });
            
            // Event listener untuk kontrol tombol
            document.getElementById('jump-btn').addEventListener('click', jump);
            document.getElementById('left-btn').addEventListener('click', () => moveLeft());
            document.getElementById('right-btn').addEventListener('click', () => moveRight());
            
            // Event listener untuk klik canvas (menempatkan/menghancurkan blok)
            canvas.addEventListener('click', function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left + camera.x) / BLOCK_SIZE);
                const y = Math.floor((e.clientY - rect.top + camera.y) / BLOCK_SIZE);
                
                // Cek apakah pemain memiliki blok yang dipilih
                if (selectedBlock && userInventory[selectedBlock.id] > 0) {
                    placeBlock(x, y);
                }
            });
            
            canvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left + camera.x) / BLOCK_SIZE);
                const y = Math.floor((e.clientY - rect.top + camera.y) / BLOCK_SIZE);
                
                breakBlock(x, y);
            });
            
            // Mulai game loop
            gameLoop();
        }
        
        // Resize canvas
        function resizeCanvas() {
            const gameWorld = document.querySelector('.game-world');
            canvas.width = gameWorld.clientWidth;
            canvas.height = gameWorld.clientHeight;
        }
        
        // Game loop
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // Update game state
        function update() {
            // Gerakkan pemain berdasarkan input
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                moveLeft();
            }
            if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                moveRight();
            }
            
            // Terapkan gravitasi
            player.velocityY += GRAVITY;
            player.y += player.velocityY;
            
            // Deteksi tabrakan dengan blok
            checkCollisions();
            
            // Update kamera untuk mengikuti pemain
            camera.x = player.x - canvas.width / 2 + player.width / 2;
            camera.y = player.y - canvas.height / 2 + player.height / 2;
            
            // Batasi kamera dalam dunia
            const worldWidth = 100 * BLOCK_SIZE;
            const worldHeight = 50 * BLOCK_SIZE;
            camera.x = Math.max(0, Math.min(camera.x, worldWidth - canvas.width));
            camera.y = Math.max(0, Math.min(camera.y, worldHeight - canvas.height));
            
            // Update posisi pemain di Firebase
            updatePlayerPosition();
        }
        
        // Fungsi gerak
        function moveLeft() {
            player.velocityX = -player.speed;
            player.facing = 'left';
        }
        
        function moveRight() {
            player.velocityX = player.speed;
            player.facing = 'right';
        }
        
        function jump() {
            if (!player.isJumping) {
                player.velocityY = JUMP_FORCE;
                player.isJumping = true;
            }
        }
        
        // Deteksi tabrakan
        function checkCollisions() {
            if (!currentWorld || !currentWorld.blocks) return;
            
            // Reset velocity X jika tidak ada input
            if (!keys['ArrowLeft'] && !keys['a'] && !keys['A'] && 
                !keys['ArrowRight'] && !keys['d'] && !keys['D']) {
                player.velocityX = 0;
            }
            
            // Posisi pemain dalam grid
            const playerLeft = Math.floor(player.x / BLOCK_SIZE);
            const playerRight = Math.floor((player.x + player.width) / BLOCK_SIZE);
            const playerTop = Math.floor(player.y / BLOCK_SIZE);
            const playerBottom = Math.floor((player.y + player.height) / BLOCK_SIZE);
            
            // Cek tabrakan dengan blok
            let onGround = false;
            
            for (let x = playerLeft; x <= playerRight; x++) {
                for (let y = playerTop; y <= playerBottom; y++) {
                    const blockKey = `${x},${y}`;
                    if (currentWorld.blocks[blockKey] && currentWorld.blocks[blockKey].type) {
                        const block = blocks.find(b => b.id === currentWorld.blocks[blockKey].type);
                        
                        // Tabrakan vertikal
                        if (player.velocityY > 0 && y === playerTop + 1) {
                            player.y = y * BLOCK_SIZE - player.height;
                            player.velocityY = 0;
                            player.isJumping = false;
                            onGround = true;
                        } else if (player.velocityY < 0 && y === playerTop - 1) {
                            player.y = (y + 1) * BLOCK_SIZE;
                            player.velocityY = 0;
                        }
                        
                        // Tabrakan horizontal
                        if (player.velocityX > 0 && x === playerLeft + 1) {
                            player.x = x * BLOCK_SIZE - player.width;
                            player.velocityX = 0;
                        } else if (player.velocityX < 0 && x === playerLeft - 1) {
                            player.x = (x + 1) * BLOCK_SIZE;
                            player.velocityX = 0;
                        }
                    }
                }
            }
            
            // Jika tidak ada tabrakan dengan tanah, pemain sedang melompat
            if (!onGround) {
                player.isJumping = true;
            }
            
            // Batasi pemain dalam dunia
            player.x = Math.max(0, Math.min(player.x, worldWidth - player.width));
            player.y = Math.max(0, Math.min(player.y, worldHeight - player.height));
        }
        
        // Render game
        function render() {
            // Clear canvas
            ctx.fillStyle = '#87CEEB'; // Warna langit
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Gambar blok-blok yang terlihat di kamera
            if (currentWorld && currentWorld.blocks) {
                const startX = Math.floor(camera.x / BLOCK_SIZE);
                const startY = Math.floor(camera.y / BLOCK_SIZE);
                const endX = Math.ceil((camera.x + canvas.width) / BLOCK_SIZE);
                const endY = Math.ceil((camera.y + canvas.height) / BLOCK_SIZE);
                
                for (let x = startX; x < endX; x++) {
                    for (let y = startY; y < endY; y++) {
                        const blockKey = `${x},${y}`;
                        const blockData = currentWorld.blocks[blockKey];
                        if (blockData && blockData.type) {
                            const blockType = blockData.type;
                            const block = blocks.find(b => b.id === blockType);
                            if (block) {
                                ctx.fillStyle = block.color;
                                ctx.fillRect(
                                    x * BLOCK_SIZE - camera.x,
                                    y * BLOCK_SIZE - camera.y,
                                    BLOCK_SIZE,
                                    BLOCK_SIZE
                                );
                                
                                // Gambar grid
                                ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                                ctx.strokeRect(
                                    x * BLOCK_SIZE - camera.x,
                                    y * BLOCK_SIZE - camera.y,
                                    BLOCK_SIZE,
                                    BLOCK_SIZE
                                );
                            }
                        }
                    }
                }
            }
            
            // Gambar pemain
            ctx.fillStyle = player.color;
            ctx.fillRect(
                player.x - camera.x,
                player.y - camera.y,
                player.width,
                player.height
            );
            
            // Gambar mata pemain berdasarkan arah
            ctx.fillStyle = 'white';
            if (player.facing === 'right') {
                ctx.fillRect(
                    player.x - camera.x + player.width - 10,
                    player.y - camera.y + 8,
                    5,
                    5
                );
            } else {
                ctx.fillRect(
                    player.x - camera.x + 5,
                    player.y - camera.y + 8,
                    5,
                    5
                );
            }
            
            // Gambar pemain lain
            for (const username in onlinePlayers) {
                if (username !== currentUser.username) {
                    const otherPlayer = onlinePlayers[username];
                    ctx.fillStyle = '#00FF00'; // Warna hijau untuk pemain lain
                    ctx.fillRect(
                        otherPlayer.x - camera.x,
                        otherPlayer.y - camera.y,
                        player.width,
                        player.height
                    );
                    
                    // Nama pemain
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText(
                        username,
                        otherPlayer.x - camera.x,
                        otherPlayer.y - camera.y - 5
                    );
                }
            }
        }
        
        // Fungsi untuk memuat dunia user
        function loadUserWorlds() {
            database.ref('users/' + currentUser.username + '/worlds').once('value').then(snapshot => {
                userWorlds = [];
                const worldList = document.getElementById('world-list');
                worldList.innerHTML = '';
                
                snapshot.forEach(childSnapshot => {
                    const world = childSnapshot.val();
                    world.key = childSnapshot.key;
                    userWorlds.push(world);
                    
                    const worldItem = document.createElement('li');
                    worldItem.className = 'world-item';
                    worldItem.textContent = world.name + ' (' + world.domain + ')';
                    worldItem.dataset.domain = world.domain;
                    
                    worldItem.addEventListener('click', function() {
                        loadWorld(world.domain);
                        
                        // Hapus class active dari semua item
                        document.querySelectorAll('.world-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Tambah class active ke item yang diklik
                        this.classList.add('active');
                    });
                    
                    worldList.appendChild(worldItem);
                });
                
                // Load dunia home secara default
                if (userWorlds.length > 0) {
                    loadWorld(userWorlds[0].domain);
                    document.querySelector('.world-item').classList.add('active');
                } else {
                    // Jika tidak ada dunia, buat dunia home
                    createNewWorld('home', 'Rumahku');
                }
            });
        }
        
        // Fungsi untuk memuat dunia
        function loadWorld(domain) {
            // Hapus listener dunia sebelumnya
            if (currentWorld) {
                database.ref('worlds/' + currentWorld.domain + '/blocks').off();
                database.ref('players').orderByChild('world').equalTo(currentWorld.domain).off();
            }
            
            database.ref('worlds/' + domain).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    currentWorld = snapshot.val();
                    currentWorld.domain = domain;
                    
                    document.getElementById('current-world').textContent = currentWorld.name + ' (' + domain + ')';
                    
                    // Posisi pemain di dunia baru
                    player.x = currentWorld.spawnX || BLOCK_SIZE * 10;
                    player.y = currentWorld.spawnY || BLOCK_SIZE * 10;
                    
                    // Update posisi pemain di Firebase
                    updatePlayerPosition();
                    
                    // Listen untuk perubahan blok
                    database.ref('worlds/' + domain + '/blocks').on('value', snapshot => {
                        currentWorld.blocks = snapshot.val() || {};
                    });
                    
                    // Listen untuk pemain lain di dunia ini
                    database.ref('players').orderByChild('world').equalTo(domain).on('value', snapshot => {
                        onlinePlayers = snapshot.val() || {};
                        updateOnlinePlayersDisplay();
                    });
                } else {
                    // Jika dunia tidak ditemukan, buat dunia baru
                    createNewWorld(domain, domain.charAt(0).toUpperCase() + domain.slice(1));
                }
            });
        }
        
        // Fungsi untuk membuat dunia baru
        function createNewWorld(domain, name) {
            const newWorld = {
                name: name,
                domain: domain,
                owner: currentUser.username,
                created: new Date().toISOString(),
                spawnX: BLOCK_SIZE * 10,
                spawnY: BLOCK_SIZE * 10,
                blocks: {}
            };
            
            // Buat tanah dasar
            for (let x = 0; x < 100; x++) {
                for (let y = 40; y < 50; y++) {
                    if (y === 40) {
                        newWorld.blocks[`${x},${y}`] = { type: 2 }; // Grass Block
                    } else {
                        newWorld.blocks[`${x},${y}`] = { type: 1 }; // Dirt Block
                    }
                }
            }
            
            // Tambah beberapa pohon
            for (let i = 0; i < 5; i++) {
                const treeX = 10 + i * 15;
                newWorld.blocks[`${treeX},39`] = { type: 21 }; // Wood Block
                newWorld.blocks[`${treeX},38`] = { type: 21 }; // Wood Block
                newWorld.blocks[`${treeX},37`] = { type: 25 }; // Leaf Block
                newWorld.blocks[`${treeX-1},37`] = { type: 25 }; // Leaf Block
                newWorld.blocks[`${treeX+1},37`] = { type: 25 }; // Leaf Block
                newWorld.blocks[`${treeX},36`] = { type: 25 }; // Leaf Block
            }
            
            database.ref('worlds/' + domain).set(newWorld)
                .then(() => {
                    // Tambah dunia ke daftar dunia user
                    database.ref('users/' + currentUser.username + '/worlds/' + domain).set({
                        domain: domain,
                        name: name,
                        created: new Date().toISOString()
                    });
                    
                    currentWorld = newWorld;
                    currentWorld.domain = domain;
                    
                    document.getElementById('current-world').textContent = currentWorld.name + ' (' + domain + ')';
                    
                    // Refresh daftar dunia
                    loadUserWorlds();
                });
        }
        
        // Fungsi untuk menempatkan blok
        function placeBlock(x, y) {
            if (!currentWorld || !selectedBlock) return;
            
            // Hanya pemilik yang bisa mengedit, atau siapa saja jika dunia publik
            if (currentWorld.owner !== currentUser.username && !currentWorld.isPublic) {
                return;
            }
            
            const blockKey = `${x},${y}`;
            
            // Cek apakah pemain memiliki blok yang cukup
            if (userInventory[selectedBlock.id] <= 0) {
                alert('Anda tidak memiliki blok ini!');
                return;
            }
            
            // Update di Firebase
            database.ref('worlds/' + currentWorld.domain + '/blocks/' + blockKey).set({
                type: selectedBlock.id
            }).then(() => {
                // Update inventory
                userInventory[selectedBlock.id]--;
                database.ref('users/' + currentUser.username + '/inventory/' + selectedBlock.id).set(userInventory[selectedBlock.id]);
                
                // Update lokal
                if (!currentWorld.blocks) currentWorld.blocks = {};
                currentWorld.blocks[blockKey] = { type: selectedBlock.id };
                
                // Update tampilan inventory
                updateInventoryDisplay();
            });
        }
        
        // Fungsi untuk menghancurkan blok
        function breakBlock(x, y) {
            if (!currentWorld) return;
            
            // Hanya pemilik yang bisa mengedit, atau siapa saja jika dunia publik
            if (currentWorld.owner !== currentUser.username && !currentWorld.isPublic) {
                return;
            }
            
            const blockKey = `${x},${y}`;
            const blockData = currentWorld.blocks[blockKey];
            
            if (blockData && blockData.type) {
                // Tambah blok ke inventory
                if (!userInventory[blockData.type]) {
                    userInventory[blockData.type] = 0;
                }
                userInventory[blockData.type]++;
                
                // Update di Firebase
                database.ref('users/' + currentUser.username + '/inventory/' + blockData.type).set(userInventory[blockData.type]);
                database.ref('worlds/' + currentWorld.domain + '/blocks/' + blockKey).remove();
                
                // Update lokal
                delete currentWorld.blocks[blockKey];
                
                // Update tampilan inventory
                updateInventoryDisplay();
            }
        }
        
        // Update posisi pemain di Firebase
        function updatePlayerPosition() {
            if (!currentWorld || !currentUser) return;
            
            database.ref('players/' + currentUser.username).set({
                x: player.x,
                y: player.y,
                world: currentWorld.domain,
                lastUpdate: new Date().toISOString()
            });
        }
        
        // Update tampilan pemain online
        function updateOnlinePlayersDisplay() {
            const onlinePlayersEl = document.getElementById('online-players');
            onlinePlayersEl.innerHTML = '';
            
            for (const username in onlinePlayers) {
                const playerEl = document.createElement('div');
                playerEl.className = 'player';
                
                const avatarEl = document.createElement('div');
                avatarEl.className = 'player-avatar';
                
                const nameEl = document.createElement('span');
                nameEl.textContent = username;
                
                playerEl.appendChild(avatarEl);
                playerEl.appendChild(nameEl);
                onlinePlayersEl.appendChild(playerEl);
            }
            
            if (Object.keys(onlinePlayers).length === 0) {
                onlinePlayersEl.innerHTML = '<div>Tidak ada pemain online</div>';
            }
        }
        
        // Fungsi untuk mengisi inventory
        function updateInventoryDisplay() {
            const inventory = document.getElementById('inventory');
            inventory.innerHTML = '';
            
            blocks.forEach(block => {
                if (userInventory[block.id] > 0) {
                    const item = document.createElement('div');
                    item.className = 'inventory-item';
                    if (block.id === selectedBlock.id) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <div class="item-icon">${block.emoji}</div>
                        <div class="item-name">${block.nameId}</div>
                        <div class="item-count">${userInventory[block.id]}</div>
                    `;
                    
                    item.addEventListener('click', function() {
                        selectedBlock = block;
                        
                        // Hapus class active dari semua item
                        document.querySelectorAll('.inventory-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Tambah class active ke item yang diklik
                        this.classList.add('active');
                    });
                    
                    inventory.appendChild(item);
                }
            });
            
            // Jika tidak ada item yang dipilih, pilih item pertama yang tersedia
            if (!selectedBlock || userInventory[selectedBlock.id] <= 0) {
                const firstAvailable = blocks.find(block => userInventory[block.id] > 0);
                if (firstAvailable) {
                    selectedBlock = firstAvailable;
                    updateInventoryDisplay();
                }
            }
        }
        
        // Event Listeners
        document.getElementById('create-world-btn').addEventListener('click', function() {
            document.getElementById('create-world-modal').style.display = 'flex';
        });
        
        document.getElementById('join-world-btn').addEventListener('click', function() {
            document.getElementById('join-world-modal').style.display = 'flex';
        });
        
        document.getElementById('cancel-create').addEventListener('click', function() {
            document.getElementById('create-world-modal').style.display = 'none';
        });
        
        document.getElementById('confirm-create').addEventListener('click', function() {
            const domain = document.getElementById('world-domain').value;
            const name = document.getElementById('world-name').value;
            
            if (!domain || !name) {
                alert('Domain dan nama dunia harus diisi!');
                return;
            }
            
            // Cek apakah domain sudah ada
            database.ref('worlds/' + domain).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    alert('Domain sudah digunakan! Pilih domain lain.');
                } else {
                    createNewWorld(domain, name);
                    document.getElementById('create-world-modal').style.display = 'none';
                    document.getElementById('world-domain').value = '';
                    document.getElementById('world-name').value = '';
                }
            });
        });
        
        document.getElementById('cancel-join').addEventListener('click', function() {
            document.getElementById('join-world-modal').style.display = 'none';
        });
        
        document.getElementById('confirm-join').addEventListener('click', function() {
            const domain = document.getElementById('join-world-domain').value;
            
            if (!domain) {
                alert('Domain dunia harus diisi!');
                return;
            }
            
            loadWorld(domain);
            document.getElementById('join-world-modal').style.display = 'none';
            document.getElementById('join-world-domain').value = '';
        });
        
        document.getElementById('logout-btn').addEventListener('click', function() {
            // Hapus data pemain dari Firebase
            if (currentUser) {
                database.ref('players/' + currentUser.username).remove();
            }
            
            localStorage.removeItem('uvoworld_user');
            window.location.href = 'login.html';
        });
        
        // Jalankan saat halaman dimuat
        window.onload = function() {
            loadUserData();
            
            // Set ukuran dunia
            worldWidth = 100 * BLOCK_SIZE;
            worldHeight = 50 * BLOCK_SIZE;
        };
        
        // Hapus data pemain saat tab ditutup
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                database.ref('players/' + currentUser.username).remove();
            }
        });
    </script>
</body>
</html>
